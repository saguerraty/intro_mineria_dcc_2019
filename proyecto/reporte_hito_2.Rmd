---
title: "Informe hito 2"
author: '@saguerraty @Bastyz @HaineAnn'
date: "October 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Avance Hito 2

```{r paquetes y setup , message=FALSE}
library(readr)
library(sqldf)
library(rprojroot)
library(ggplot2)
library(nnet)
library(stats)
library(ROCR)
library(rpart)
library(PRROC)
library(corrplot)
getwd()
setwd("C:/Users/sague/Documents/GitHub/intro_mineria_dcc_2019/proyecto")
```
## Contexto y motivación


```{r leer datos y mergear , message=FALSE , echo=FALSE}
emergencia=read_csv("./scrapping_emergencia_aire/predLimpias.csv")
atmos=read_csv("./ClimaYEmisionesData/DatosHito1CleanWithDates.csv")

#arreglar error de formato en pre emergencia
emergencia$'ESTADO MP10'[emergencia$`ESTADO MP10`=="PREEMERGENCIA"]<-"PRE EMERGENCIA"

tabla=sqldf("SELECT atmos.*,
            emergencia.'ESTADO MP10' as 'cat_mp10',
            emergencia.'ESTADO MP2,5' as 'cat_mp25' 
            FROM atmos JOIN emergencia ON atmos.Fecha = emergencia.Fecha", drv="SQLite")

write_csv(tabla,"./tabla_imbalanced.csv")
```
## Datos

### Catacterización de los datos
```{r}

tabla_ss= subset(tabla, select = -c(MP10,MP25))
# tabla_ss$cat_mp10[tabla_ss$cat_mp10=="PREEMERGENCIA"]<-"PRE EMERGENCIA"

tabla_ss$cat_mp10<- as.factor(tabla_ss$cat_mp10)
train_ind=sample(seq_len(nrow(tabla)),size = nrow(tabla)*0.7)
tabla_learn = tabla_ss[train_ind,]
tabla_test = tabla_ss[-train_ind,]

tabla_learn$cat_mp10=relevel(tabla_learn$cat_mp10, ref = "REGULAR")
mod_multi_log=multinom(cat_mp10~O3+CO+Tmedia+Tmax+Precipitaciones, data = tabla_learn)

tabla_test$pred_multilog = predict(mod_multi_log, newdata = tabla_test)

tabla_test<-tabla_test[which(!is.na(tabla_test$pred_multilog)),]

rocs = roc.curve(tabla_test$cat_mp10,tabla_test$pred_multilog, curve = TRUE)
plot(rocs)

summary(mod_multi_log)
```
Además los datos para algunas de las fechas no poseen todas las mediciones, por lo que se deben manejar los casos en que no hay valores en alguna columna. Los valores faltantes por cada columna son:

```{r}
na_count <-sapply(tabla, function(y) sum(length(which(is.na(y)))))
na_count <- data.frame(na_count)
na_count
```
#### Correlacion de los datos
```{r}
tabla.cor <- cor(subset(tabla, select = -c(cat_mp10,cat_mp25,Fecha,anno,dia,MP25,NO2)), use = "pairwise.complete.obs" )
corrplot( tabla.cor )

```


### Balanceo de las clases

El dataset de caracterización de situación de emergencia en su estado original tiene las clases de 'pre emergencia' y 'pre alerta' subrepresentadas, lo que probablemente explica el mal rendimiento de predicción del modelo Logit multinomial par esas clases. Como solución a este problema se aplicó oversampeling utilizando 'SMOTE' ya que es un problema de oversampeling multiclase. El código para realizar el oversampeling se hizo en python debido a que la implementación de SMOTE en R está pensaba para un clasificador binario, por lo que se utilizó el subpaquete: 'random_oversampeling' de la libreria 'imblearn'.
```{r}
ggplot(emergencia)+geom_bar(aes(`ESTADO MP10`))
```